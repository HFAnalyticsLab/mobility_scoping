---
title: "Residential mobility maps"

output:
   html_document:
    toc: true
    toc_float: true
    theme: paper
    

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(tidyverse,
               sf,
               XML,
               tmap,
               viridis, 
               aws.s3,
               rio,
               janitor,
               png,
               knitr)

```
               
              

```{r, include=FALSE}
#Load data 
buck <- 'thf-dap-tier0-projects-iht-067208b7-projectbucket-1mrmynh0q7ljp/Francesca/mobility_scoping/data/clean' ## my bucket name

lsoa_shp<-s3read_using(readRDS # Which function are we using to read
                      , object = 'lsoa_cdrc.RDS' # File to open
                      , bucket = buck) # Bucket name defined above

```


## Background {.tabset}

This is an R markdown document to show initial maps for scoping


<!-- ## Net migration by age (England) {.tabset .tabset-dropdown} -->

## Net migration by age (England) {.tabset}

### Under 35 
```{r echo=FALSE}


img1_path <- here::here('outputs', "map10_1.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Under 35-64
```{r echo=FALSE}
img1_path <- here::here('outputs', "map10_2.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)



```


### 65+ years
```{r echo=FALSE}
img1_path <- here::here('outputs', "map10_3.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


## Net migration by age (London) {.tabset}

### Under 35 
```{r echo=FALSE}
img1_path <- here::here('outputs', "map10_4.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Under 35-64
```{r echo=FALSE}
img1_path <- here::here('outputs', "map10_5.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### 65+ years 
```{r echo=FALSE}
img1_path <- here::here('outputs', "map10_6.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```

## Mean age (England and Wales)  {.tabset} 

### Usual residents in 2010
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_5.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Usual residents in 2011 
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_6.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Difference in mean age 2010-11
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_7.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```

### Difference in mean age - categorical 2010/11
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_8.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


## Mean age (London)  {.tabset} 

### Usual residents in 2010
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_13.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Usual residents in 2011 
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_14.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### Difference in mean age 2010-11
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_15.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```

### Difference in mean age - categorical 2010/11
```{r echo=FALSE}
img1_path <- here::here('outputs', "map9_16.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```



## Net Migration and MSOA IMD (England)  {.tabset} 

### MSOA rank
```{r echo=FALSE}
img1_path <- here::here('outputs', "map11_1.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### MSOA IMD index
```{r echo=FALSE}
img1_path <- here::here('outputs', "map11_2.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


### MSOA IMD decile
```{r echo=FALSE}
img1_path <- here::here('outputs', "map11_3.png")
img1 <- readPNG(img1_path, native = TRUE, info = TRUE)

include_graphics(img1_path)


```


## Churn index for England (LSOA level) {.tabset}

The churn index from 1997-2020. 
The data simply provides a ratio of the households that are different in each LSOA between the end of 2020 and the end of each year going back to 1997. 

Residential mobility ("Population Churn") is estimated at the household level. Shows the proportion of change in households compared to 2020. 

```{r, echo=FALSE}
# Prepare THF colour scheme
pal_THF <- c('#dd0031', '#53a9cd',  '#744284',  '#ffd412',   '#2a7979', '#ee9b90', '#0c402b', '#a6d7d3', '#005078', '#f39214', '#2ca365')
grDevices::palette(pal_THF)
# not sure what the palette command does

map_churn<- function(data=lsoa_shp,var=col) {
tm_shape(data) +
    tm_borders(,alpha=0) +
    tm_fill(col = var, style="cont", palette = "viridis", title = paste0("Churn index", substr(var,4,7))) +
    tm_layout(legend.title.size = 0.8,
              legend.text.size = 0.6,
              legend.position = c("left","top"),
              legend.bg.color = "white",
              legend.bg.alpha = 1) 

}

# loop.vector<-11:33
# vars<-list()
# lsoa_shp_cdrc<-lsoa_shp[,11:33]
# 
# for (j in seq_along(loop.vector)) {
#   vars[[j]]<-as.name(colnames(lsoa_shp_cdrc)[j])
# }
# 
# g<-lapply(as.character(vars[1:length(vars)]),map_churn,data=lsoa_shp)


```


### 2010
```{r, echo=FALSE}
map_churn(data=lsoa_shp, var="chn2010")
```

### 2011
```{r, echo=FALSE}
map_churn(data=lsoa_shp, var="chn2011")
```

### 2019
```{r, echo=FALSE}
map_churn(data=lsoa_shp, var="chn2019")
```

## Churn index for London only (LSOA level) {.tabset}

```{r, echo=FALSE}

# vars<-list()
# lsoa_shp_cdrc<-lsoa_shp[,11:33]
# 
# for (j in seq_along(loop.vector)) {
#   vars[[j]]<-as.name(colnames(lsoa_shp_cdrc)[j])
# }

ldn_lsoa_shp <- lsoa_shp %>%
  dplyr::filter(, substring(LSOA11CD, 2) < '01004681' & str_detect(LSOA11CD, 'E'))

# l<-lapply(as.character(vars[1:length(vars)]),map_churn,data=ldn_lsoa_shp)




```


### 2010
```{r, echo=FALSE}
map_churn(data=ldn_lsoa_shp, var="chn2010")
```

### 2011
```{r, echo=FALSE}
map_churn(data=ldn_lsoa_shp, var="chn2011")
```

### 2019
```{r, echo=FALSE}
map_churn(data=ldn_lsoa_shp, var="chn2019")
```